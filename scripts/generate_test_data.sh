#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏
# –°–æ–∑–¥–∞–µ—Ç –¥—Ä—É–∂–±—ã –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ 1-5 –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 100,000 –ø–æ—Å—Ç–æ–≤

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
SRC_DIR="$PROJECT_ROOT/src"

echo "üöÄ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ª–µ–Ω—Ç—ã –ø–æ—Å—Ç–æ–≤"
echo "=============================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
echo "üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API —Å–µ—Ä–≤–µ—Ä–∞..."
if ! curl -s http://localhost:8080/api/v1/feed > /dev/null 2>&1; then
    echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ http://localhost:8080"
    echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –∫–æ–º–∞–Ω–¥–æ–π: cd src && ./social-network"
    exit 1
fi

echo "‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Redis –∑–∞–ø—É—â–µ–Ω
echo "üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Redis..."
if command -v redis-cli >/dev/null 2>&1 && redis-cli ping >/dev/null 2>&1; then
    echo "‚úÖ Redis –¥–æ—Å—Ç—É–ø–µ–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)"
elif docker-compose exec -T redis redis-cli ping >/dev/null 2>&1; then
    echo "‚úÖ Redis –¥–æ—Å—Ç—É–ø–µ–Ω (Docker)"
elif curl -s http://localhost:6379 >/dev/null 2>&1; then
    echo "‚úÖ Redis –¥–æ—Å—Ç—É–ø–µ–Ω (–ø–æ—Ä—Ç 6379)"
else
    echo "‚ùå Redis –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: docker-compose ps redis"
    echo "   –ò–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: docker-compose up -d redis"
    echo "   –õ–æ–∫–∞–ª—å–Ω–æ: redis-server"
    exit 1
fi

echo "‚úÖ Redis –¥–æ—Å—Ç—É–ø–µ–Ω"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –∏—Å—Ö–æ–¥–Ω–∏–∫–∞–º–∏
cd "$SRC_DIR"

# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
echo "üî® –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–∞–Ω–Ω—ã—Ö..."
go build -o generate_test_data ./cmd/generate_test_data/

if [ ! -f "generate_test_data" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞"
    exit 1
fi

echo "‚úÖ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω"

# –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
echo ""
echo "üéØ –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö..."
echo "   - –î—Ä—É–∂–±—ã –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ 1-5"
echo "   - 100,000 –ø–æ—Å—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π 1-10"
echo ""

# –ó–∞—Å–µ–∫–∞–µ–º –≤—Ä–µ–º—è
start_time=$(date +%s)

./generate_test_data

# –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
end_time=$(date +%s)
duration=$((end_time - start_time))

echo ""
echo "üéâ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ $duration —Å–µ–∫—É–Ω–¥!"
echo ""

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:"
echo "   - –î—Ä—É–∂–±—ã: 10 —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ 1-5"
echo "   - –ü–æ—Å—Ç—ã: 100,000 –ø–æ—Å—Ç–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π 1-10"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—á–µ—Ä–µ–¥–∏
echo "‚öôÔ∏è –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–µ–Ω—Ç:"
curl -s http://localhost:8080/api/v1/admin/queue/stats | jq . 2>/dev/null || curl -s http://localhost:8080/api/v1/admin/queue/stats

echo ""
echo "üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1: curl 'http://localhost:8080/api/v1/feed?limit=10' -H 'X-User-ID: 1'"
echo "   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏: curl http://localhost:8080/api/v1/admin/queue/stats"
echo "   - –ü–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –∫–µ—à–∞: curl -X POST http://localhost:8080/api/v1/admin/feed/rebuild-all"

# –û—á–∏—Å—Ç–∫–∞
rm -f generate_test_data

echo ""
echo "‚ú® –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–µ–Ω—Ç—É –ø–æ—Å—Ç–æ–≤."
