# Диалоги (Личные сообщения)

## Описание

Реализована система личных сообщений (диалогов) между пользователями с поддержкой горизонтального масштабирования и динамического перераспределения нагрузки (resharding, "Lady Gaga effect").

- Сообщения хранятся в N шардированных таблицах (`messages_0`, `messages_1`, ..., `messages_{N-1}`), где N задаётся параметром.
- Для каждого пользователя поддерживается отображение user_id → shard_id в таблице `shard_map`.
- Перераспределение (resharding) возможно для "горячих" пользователей без даунтайма.

## Архитектура

### Основные сущности
- **Message**: сообщение между двумя пользователями (отправитель, получатель, текст, время).
- **ShardMap**: отображение user_id → shard_id (для быстрого поиска и поддержки resharding).

### Принцип работы
1. При отправке сообщения определяется shard_id для отправителя и/или получателя через `shard_map`.
2. Сообщение сохраняется в соответствующую таблицу `messages_{shard_id}`.
3. Для "горячих" пользователей (с высокой активностью) возможен перенос на отдельный shard (resharding) с обновлением `shard_map`.
4. Чтение диалога между двумя пользователями агрегирует сообщения из соответствующих шардов.

### Resharding и "Lady Gaga effect"
- Для пользователей с аномально высокой активностью ("hot users") выделяется отдельный shard.
- Перенос осуществляется обновлением записи в `shard_map` и миграцией сообщений.
- Обычные пользователи равномерно распределяются по N шардов (например, по user_id % N).

## API

### Основные эндпоинты

#### Отправка сообщения
```
POST /api/v1/dialog/{user_id}/send
Content-Type: application/json
{
  "to": <user_id>,
  "text": "Текст сообщения"
}
```
- Отправляет сообщение от текущего пользователя к указанному user_id.

#### Получение диалога
```
GET /api/v1/dialog/{user_id}/list?limit=50&offset=0
```
- Получает список сообщений между текущим пользователем и user_id (с пагинацией).

### Пример схемы Message
| Поле         | Тип        | Описание                |
|--------------|------------|-------------------------|
| id           | bigint     | Уникальный идентификатор|
| from_id      | bigint     | Отправитель             |
| to_id        | bigint     | Получатель              |
| text         | text       | Текст сообщения         |
| created_at   | timestamp  | Время отправки          |

## Масштабирование и отказоустойчивость
- Количество шардов можно увеличить без даунтайма (resharding).
- Для "горячих" пользователей выделяются отдельные шарды.
- Все операции атомарны, поддерживается консистентность при миграции.

## Мониторинг и best practices
- Следить за распределением нагрузки по шардовым таблицам.
- Для hot users — автоматизировать перенос на отдельный shard.
- Регулярно проверять консистентность shard_map и сообщений.

---

*Последнее обновление: 2025-09-06*
