# Лента постов друзей

## Описание

Реализован механизм ленты постов друзей с использованием Redis для кеширования. Система поддерживает:

- Кеширование лент постов в Redis с TTL 24 часа
- Максимум 1000 постов в ленте одного пользователя
- Правильную инвалидацию кеша при создании/удалении постов
- Обновление лент через очередь Redis (5 воркеров)
- Возможность перестройки кешей из СУБД

## Архитектура

### Компоненты

1. **PostService** - основной сервис для работы с постами и лентами
2. **QueueService** - сервис для обработки задач обновления лент через очередь
3. **Redis** - кеширование лент и очередь задач

### Структура кеша

- **Лента пользователя**: `user_feed:{user_id}` - Redis Sorted Set (score = timestamp)
- **Кеш постов**: `post:{post_id}` - JSON данные поста
- **Очередь**: `feed_update_queue` - список задач обновления

## API Endpoints

### Основные эндпоинты

#### Создание поста
```
POST /api/v1/posts/create
Content-Type: application/json

{
  "content": "Текст поста"
}
```

#### Удаление поста
```
DELETE /api/v1/posts/{post_id}
```

#### Получение ленты
```
GET /api/v1/feed?limit=20&last_id=123
```

Параметры:
- `limit` - количество постов (по умолчанию 20, максимум 100)
- `last_id` - ID последнего поста для пагинации

### Административные эндпоинты

#### Инвалидация кеша ленты пользователя
```
DELETE /api/v1/admin/cache/feed/{user_id}
```

#### Перестройка ленты пользователя из БД
```
POST /api/v1/admin/feed/rebuild/{user_id}
```

#### Перестройка всех лент из БД
```
POST /api/v1/admin/feed/rebuild-all
```

#### Статистика очереди
```
GET /api/v1/admin/queue/stats
```

## Конфигурация

Пример конфигурации Redis в `app.yaml`:

```yaml
redis:
  host: "localhost"
  port: 6379
  password: ""
  db: 0
```

## Принцип работы

### Создание поста

1. Пост сохраняется в БД
2. Задача обновления лент добавляется в очередь Redis
3. Воркеры асинхронно обрабатывают задачу:
   - Получают список друзей автора
   - Добавляют пост в ленты всех друзей
   - Ограничивают размер лент (1000 постов)

### Получение ленты

1. Попытка получить ленту из Redis кеша
2. Если кеш пуст или устарел - построение ленты из БД
3. Кеширование результата в Redis
4. Возврат ленты с пагинацией

### Инвалидация кеша

- При добавлении/удалении друзей
- При изменении настроек приватности
- По административным командам
- Автоматически по TTL (24 часа)

## Масштабирование

- Воркеры очереди можно масштабировать изменением `QUEUE_WORKER_COUNT`
- Redis можно кластеризовать для увеличения производительности
- Размер лент можно настроить через `MAX_FEED_SIZE`
- TTL кеша настраивается через `FEED_CACHE_TTL`

## Мониторинг

- Статистика очереди через `/admin/queue/stats`
- Логи воркеров в стандартный вывод
- Метрики Redis (длина очереди, использование памяти)

## Устойчивость к сбоям

- Fallback на синхронное обновление лент при недоступности очереди
- Graceful degradation - работа без кеша при недоступности Redis
- Идемпотентность операций обновления лент
