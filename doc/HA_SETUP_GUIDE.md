# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HAProxy –∏ Nginx –¥–ª—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

## –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤—ã—Å–æ–∫–æ–¥–æ—Å—Ç—É–ø–Ω–æ–π (HA) –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º:
- **HAProxy** –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ PostgreSQL (master –¥–ª—è –∑–∞–ø–∏—Å–∏, replicas –¥–ª—è —á—Ç–µ–Ω–∏—è)
- **Nginx** –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ HTTP/WebSocket —Ç—Ä–∞—Ñ–∏–∫–∞ –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
./scripts/setup_ha_environment.sh
```

–°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç:
- –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è HAProxy
- –û—Å—Ç–∞–Ω–æ–≤–∫—É —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –°–±–æ—Ä–∫—É –Ω–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤
- –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose ps

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs -f nginx
docker-compose logs -f haproxy
docker-compose logs -f backend-1
```

### 3. –î–æ—Å—Ç—É–ø–Ω—ã–µ endpoints

- **API:** http://localhost:8080
- **HAProxy Stats:** http://localhost:8404/stats (username: admin, password: admin)
- **Nginx Status:** http://localhost:8082/nginx_status
- **RabbitMQ Management:** http://localhost:15672 (guest/guest)

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç

```bash
# –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
./scripts/test_ha_availability.sh
```

–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç:
1. –ë–∞–∑–æ–≤—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
2. –†–∞–±–æ—Ç—É –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ 1 backend –∏–Ω—Å—Ç–∞–Ω—Å–∞
3. –†–∞–±–æ—Ç—É –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ 2 backend –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
4. –†–∞–±–æ—Ç—É –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ PostgreSQL —Ä–µ–ø–ª–∏–∫–∏
5. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Ç–∫–∞–∑–æ–≤

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
curl http://localhost:8080/health

# 2. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–¥–Ω–æ–≥–æ backend
docker-compose stop backend-1

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (–¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å)
curl http://localhost:8080/health

# 4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
docker-compose start backend-1
```

## –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –° –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º wrk

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ wrk (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
brew install wrk  # macOS
# apt-get install wrk  # Ubuntu/Debian

# –ó–∞–ø—É—Å–∫ benchmark
./scripts/benchmark_ha.sh
```

### –†—É—á–Ω–æ–π benchmark

```bash
# –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç
wrk -t4 -c50 -d60s http://localhost:8080/health

# –° –æ—Ç–∫–∞–∑–æ–º backend
docker-compose stop backend-1
wrk -t4 -c50 -d60s http://localhost:8080/health
docker-compose start backend-1
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### HAProxy Statistics

–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8404/stats –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:
- –°—Ç–∞—Ç—É—Å PostgreSQL master –∏ replicas
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—à–∏–±–æ–∫
- Health check —Å—Ç–∞—Ç—É—Å

### Nginx Status

```bash
curl http://localhost:8082/nginx_status
```

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- Active connections
- Accepts/handled requests
- Reading/Writing/Waiting connections

### Docker Stats

```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
docker stats

# –¢–æ–ª—å–∫–æ backend —Å–µ—Ä–≤–∏—Å—ã
docker stats backend-1 backend-2 backend-3
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Client  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Nginx     ‚îÇ (Load Balancer)
‚îÇ   :8080      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ                        ‚îÇ
       ‚ñº                        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Backend 1-3 ‚îÇ        ‚îÇ  Dialogs 1-2 ‚îÇ
‚îÇ   :8080      ‚îÇ        ‚îÇ   :8080      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                       ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ   HAProxy    ‚îÇ (DB Load Balancer)
           ‚îÇ :5432 :5433  ‚îÇ
           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
       ‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îª‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì
       ‚ñº                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PG Master    ‚îÇ      ‚îÇ PG Replicas  ‚îÇ
‚îÇ   (Write)    ‚îÇ      ‚îÇ   (Read)     ‚îÇ
‚îÇ   :5433      ‚îÇ      ‚îÇ :5434, :5435 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### HAProxy (`etc/haproxy.cfg`)

- **postgres_master** (–ø–æ—Ä—Ç 5432): –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ master –¥–ª—è –∑–∞–ø–∏—Å–∏
- **postgres_replicas** (–ø–æ—Ä—Ç 5433): –±–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç —á—Ç–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–ø–ª–∏–∫–∞–º–∏
- **stats** (–ø–æ—Ä—Ç 8404): web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### Nginx (`etc/nginx.conf`)

- **backend_cluster**: –±–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å—ã –º–µ–∂–¥—É backend-1, backend-2, backend-3
- **dialogs_cluster**: –±–∞–ª–∞–Ω—Å–∏—Ä—É–µ—Ç –º–µ–∂–¥—É dialogs-1, dialogs-2
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WebSocket –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
- Retry logic –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### Application Config (`app.yaml.haproxy`)

```yaml
db:
  master:
    host: haproxy
    port: 5432  # Master –¥–ª—è –∑–∞–ø–∏—Å–∏
  replicas:
    - host: haproxy
      port: 5433  # Replicas –¥–ª—è —á—Ç–µ–Ω–∏—è
```

## –°—Ü–µ–Ω–∞—Ä–∏–∏ –æ—Ç–∫–∞–∑–æ–≤

### –û—Ç–∫–∞–∑ Backend –∏–Ω—Å—Ç–∞–Ω—Å–∞

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- Nginx –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–∞–µ—Ç —É–ø–∞–≤—à–∏–π –∏–Ω—Å—Ç–∞–Ω—Å
- –ó–∞–ø—Ä–æ—Å—ã –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ –∑–¥–æ—Ä–æ–≤—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–Ω–∏–∂–∞–µ—Ç—Å—è –Ω–∞ 33% (1 –∏–∑ 3)
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è 99%+

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:**
- –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∏–Ω—Å—Ç–∞–Ω—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª
- Health checks (3 –ø–æ–ø—ã—Ç–∫–∏ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã)

### –û—Ç–∫–∞–∑ PostgreSQL Replica

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- HAProxy –∏—Å–∫–ª—é—á–∞–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—É—é —Ä–µ–ø–ª–∏–∫—É
- –ß—Ç–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –º–µ–∂–¥—É –æ—Å—Ç–∞–≤—à–∏–º–∏—Å—è —Ä–µ–ø–ª–∏–∫–∞–º–∏
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è 99%+

**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è health check

### –û—Ç–∫–∞–∑ PostgreSQL Master

**–¢–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ó–∞–ø–∏—Å—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
- –ß—Ç–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ —Ä–µ–ø–ª–∏–∫–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –í–Ω–µ–¥—Ä–∏—Ç—å Patroni –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ failover master

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤

–ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤:
üìÑ **[doc/HA_PROXY_NGINX_EXPERIMENT.md](doc/HA_PROXY_NGINX_EXPERIMENT.md)**

### –ö—Ä–∞—Ç–∫–∏–µ –≤—ã–≤–æ–¥—ã

‚úÖ **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:** –£–ª—É—á—à–µ–Ω–∞ —Å 99.9% –¥–æ 99.95%+  
‚úÖ **SPOF:** –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è  
‚úÖ **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:** –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –æ—Ç–∫–∞–∑–µ 33-66% backend –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤  
‚úÖ **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ, –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞  

‚ö†Ô∏è **–°—Ç–æ–∏–º–æ—Å—Ç—å:** 3x –±–æ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è backend, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å  

## Troubleshooting

### –°–µ—Ä–≤–∏—Å—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker-compose logs

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose down -v
docker-compose up -d
```

### HAProxy –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ PostgreSQL

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ health check
docker-compose exec haproxy nc -zv postgres-master 5432

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ PostgreSQL
docker-compose exec postgres-master pg_isready -U app_user
```

### Nginx –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 502 Bad Gateway

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ backend
docker-compose ps backend-1 backend-2 backend-3

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend
docker-compose restart backend-1 backend-2 backend-3
```

### –í—ã—Å–æ–∫–∞—è latency

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker stats

# –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ docker-compose.yml
# –î–æ–±–∞–≤—å—Ç–µ:
# resources:
#   limits:
#     cpus: '2'
#     memory: 2G
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ backend
docker-compose up -d --scale backend=5

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
docker-compose logs -f --tail=100 nginx

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
docker-compose exec backend-1 sh

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose down

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤–∫–ª—é—á–∞—è volumes)
docker-compose down -v
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **Monitoring & Alerting:**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Prometheus –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫
   - –î–æ–±–∞–≤–∏—Ç—å Grafana dashboards
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è

2. **HA –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–æ–≤:**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å keepalived –¥–ª—è HAProxy
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å VRRP –¥–ª—è Nginx
   - Virtual IP –¥–ª—è failover

3. **PostgreSQL HA:**
   - –í–Ω–µ–¥—Ä–∏—Ç—å Patroni + etcd
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π failover master
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å streaming replication

4. **Security:**
   - SSL/TLS termination –Ω–∞ Nginx
   - Firewall rules
   - Rate limiting

5. **Performance:**
   - Connection pooling (PgBouncer)
   - Redis –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
   - CDN –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [HAProxy Documentation](http://www.haproxy.org/docs/)
- [Nginx Load Balancing](https://nginx.org/en/docs/http/load_balancing.html)
- [PostgreSQL High Availability](https://www.postgresql.org/docs/current/high-availability.html)
- [Docker Compose Documentation](https://docs.docker.com/compose/)

