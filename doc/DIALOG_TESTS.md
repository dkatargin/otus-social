# Тесты для системы диалогов (личных сообщений)

## Описание тестов

Файл `src/tests/05_dialog_test.go` содержит комплексные тесты для проверки функциональности диалогов (отправка и получение сообщений, пагинация, права доступа, корректность шардирования).

Файл `src/tests/06_sharding_test.go` содержит тесты для проверки корректности работы шардирования и resharding (в том числе для hot users).

## Покрытие тестами

### 1. TestDialogSendAndList — базовые сценарии
- ✅ Отправка сообщения между пользователями
- ✅ Получение списка сообщений (диалога)
- ✅ Пагинация сообщений
- ✅ Проверка прав доступа (нельзя читать чужие диалоги)

### 2. TestDialogSharding — шардирование и resharding
- ✅ Сообщения попадают в правильный shard
- ✅ Перенос пользователя на отдельный shard (resharding)
- ✅ Проверка консистентности после миграции

## Запуск тестов

### Все тесты диалогов
```bash
cd src
go test ./tests -run TestDialog -v
```

### Конкретный тест
```bash
# Проверка отправки и получения сообщений
go test ./tests -run TestDialogSendAndList -v

# Проверка шардирования и resharding
go test ./tests -run TestDialogSharding -v
```

### С покрытием кода
```bash
go test ./tests -cover -coverprofile=coverage.out
go tool cover -html=coverage.out -o coverage.html
```

## Требования для запуска
- PostgreSQL (или SQLite для unit-тестов)
- Все зависимости Go (`go mod tidy`)

## Проверяемые сценарии

### Сценарий 1: Отправка и получение сообщений
1. Создаются 2 пользователя
2. Отправляется несколько сообщений между ними
3. Проверяется корректность диалога (сортировка, содержимое)

### Сценарий 2: Пагинация
1. Создаётся много сообщений
2. Запрашивается первая страница с limit=3
3. Запрашивается вторая страница с offset
4. Проверяется отсутствие дублирования

### Сценарий 3: Resharding ("Lady Gaga effect")
1. Пользователь переносится на отдельный shard
2. Проверяется, что новые сообщения пишутся в новый shard
3. Проверяется консистентность диалога

## Результат тестирования
- ✅ Корректность бизнес-логики диалогов
- ✅ Корректность шардирования и resharding
- ✅ Права доступа
- ✅ Производительность при масштабировании

---

*Последнее обновление: 2025-09-06*
