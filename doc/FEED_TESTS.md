# Тесты для ленты постов друзей

## Описание тестов

Файл `tests/04_feed_test.go` содержит комплексные тесты для проверки функциональности ленты постов друзей.

## Покрытие тестами

### 1. TestFeedDisplay - Основное отображение ленты
- ✅ **GetFeedSuccess** - успешное получение ленты с постами друзей
- ✅ **GetFeedWithPagination** - тестирование пагинации с параметрами limit и last_id
- ✅ **GetFeedUnauthorized** - проверка авторизации
- ✅ **GetFeedNoFriends** - поведение для пользователя без друзей

### 2. TestFeedCaching - Кеширование
- ✅ **FeedCacheHit** - проверка работы кеша (повторные запросы)
- ✅ **CacheInvalidation** - тестирование инвалидации кеша
- ✅ **CacheRebuild** - перестройка кеша из БД

### 3. TestPostDeletion - Удаление постов
- ✅ **DeletePostSuccess** - успешное удаление поста и его исчезновение из лент
- ✅ **DeletePostUnauthorized** - защита от удаления чужих постов

### 4. TestQueueStats - Статистика очереди
- ✅ **GetQueueStats** - получение статистики воркеров и длины очереди

### 5. TestFeedLimits - Валидация параметров
- ✅ **FeedLimitValidation** - проверка ограничений на количество постов

### 6. TestFeedWithoutRedis - Отказоустойчивость
- ✅ **FeedWorksWithoutRedis** - работа без Redis (fallback на БД)

## Архитектура тестов

### Тестовое окружение
- **SQLite в памяти** - изолированная тестовая БД для каждого теста
- **Redis БД #1** - отдельная БД для тестов (автоматическая очистка)
- **Мок аутентификации** - эмуляция через заголовок `X-User-ID`

### Утилиты тестирования
```go
// Создание тестового пользователя
func createTestUser(t *testing.T, firstName, lastName string) *models.User

// Установка дружбы между пользователями
func createFriendship(t *testing.T, userID, friendID int64)

// Создание тестового поста
func createTestPost(t *testing.T, router *gin.Engine, userID int64, content string) *models.Post
```

## Запуск тестов

### Все тесты ленты
```bash
cd src
go test ./tests -run TestFeed -v
```

### Конкретный тест
```bash
# Тестирование отображения ленты
go test ./tests -run TestFeedDisplay -v

# Тестирование кеширования
go test ./tests -run TestFeedCaching -v

# Тестирование удаления постов
go test ./tests -run TestPostDeletion -v
```

### С покрытием кода
```bash
go test ./tests -cover -coverprofile=coverage.out
go tool cover -html=coverage.out -o coverage.html
```

## Требования для запуска

### 1. Redis сервер
```bash
# Запуск Redis локально
redis-server

# Или через Docker
docker run -d -p 6379:6379 redis:latest
```

### 2. Зависимости
```bash
go mod tidy
```

## Проверяемые сценарии

### Сценарий 1: Создание и отображение постов
1. Создаются 3 пользователя
2. Устанавливается дружба между ними
3. Создаются посты от разных пользователей
4. Проверяется корректность ленты (сортировка, содержимое)

### Сценарий 2: Пагинация
1. Создается много постов
2. Запрашивается первая страница с limit=3
3. Запрашивается вторая страница с last_id
4. Проверяется отсутствие дублирования

### Сценарий 3: Кеширование
1. Делается запрос ленты (создается кеш)
2. Повторный запрос (использует кеш)
3. Инвалидация кеша
4. Перестройка кеша из БД

### Сценарий 4: Жизненный цикл поста
1. Создается пост
2. Проверяется его наличие в ленте друга
3. Пост удаляется
4. Проверяется его отсутствие в ленте

## Результат тестирования

Все тесты проверяют:
- ✅ Корректность бизнес-логики ленты
- ✅ Работу кеширования и инвалидации
- ✅ Пагинацию и сортировку
- ✅ Асинхронную обработку через очереди
- ✅ Отказоустойчивость (работа без Redis)
- ✅ Безопасность (авторизация, права доступа)
- ✅ Производительность кеша

## Мониторинг тестов

При запуске тестов логируются:
- Время выполнения запросов (с кешем и без)
- Состояние очередей
- Операции с кешем

Пример вывода:
```
=== RUN   TestFeedDisplay/GetFeedSuccess
=== RUN   TestFeedCaching/FeedCacheHit
First request: 2.1ms, Second request: 890µs
--- PASS: TestFeedCaching/FeedCacheHit (0.10s)
```
